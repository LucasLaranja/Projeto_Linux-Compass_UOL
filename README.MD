# üë®‚Äçüíª Projeto Linux - Compass UOL - DevSecOps Abril 2025

## Monitorando servidor nginx com Webhook

### Etapas:

* Configura√ß√£o do ambiente;

* Como instalar e configurar o servidor web;

* Como funciona o script de monitoramento;

* Teste e valida√ß√£o da solu√ß√£o.

* Conclus√£o

---
## Etapa 1 - Configura√ß√£o do ambiente:
    Nesse projeto decide utilizar uma m√°quina virtual da Oracle VirtualBox, utilizando o sistema Ubuntu como sugerido, na vers√£o 25.04. Habilitando o modo bridge e configurando nos seus requisitos m√≠nimos.

    ![Print 1](/Prints/1.png)

    ![Print 2](/Prints/2.png)
--

Foi necess√°rio criar um servidor para receber a mensagem via webhook, foram dadas as op√ß√µes de utilizar Discord, Telegram ou Slack. No caso desse projeto foi utilizado o Discord.

![Print 3](/Prints/3.png)

![Print 4](/Prints/4.png)

![Print 5](/Prints/5.png)

---

## Etapa 2 - Como instalar e configurar o servidor web:
    Ap√≥s configurar o ambiente, faremos a instala√ß√£o de algumas aplica√ß√µes:
    >`apt-get install nginx` - Servidor Web

    >`apt-get install curl` - Para verificar a conectividade da URL

    Logo ap√≥s fui at√© at√© a pasta www atrav√©s do comando:
    >`cd /var/www`

    E criei uma pasta nova dedicada ao projeto e inseri o HTML na pasta. Sendo o nome da pasta devseclaranja.local. Ap√≥s isso comecei a personalizar o HTML com css, at√© um n√≠vel que considerei satisfat√≥rio.

    ![Print 6](/Prints/6.png)

    Adicionei a ele algumas informa√ß√µes do projeto e o finalizei.

---

## Etapa 3 - Como funciona o script de monitoramento:
    Em seguida fui para a parte de cria√ß√£o do script, no meu caso criei uma pasta chamada scripts na pasta nginx localizada em:
    >`cd /etc/nginx`

    E nela criei um script chamado verifica_siteprojeto.sh, foram dadas outras op√ß√µes como utilizar python para o script, mas optei por usar bash, assim criei o c√≥digo.
    ```
#!/bin/bash

SITE_URL="http://devseclaranja.local"
WEBHOOK="https://discord.com/api/webhooks/..."
LOG="/var/log/devseclaranja.log"

while true; do
    DATA_HORA=$(date '+%d/%m/%Y %H:%M:%S')
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")

    if [ "$STATUS" != "200" ]; then
        echo "$DATA_HORA - [$SITE_URL] est√° offline! Status: $STATUS" >> "$LOG"

        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{\"content\": \"O site [$SITE_URL] est√° apresentando erro! C√≥digo HTTP: $STATUS - $DATA_HORA\"}" \
             "$WEBHOOK"
    else
        echo "$DATA_HORA - [$SITE_URL] Est√° online! - Status: $STATUS" >> "$LOG"
    fi

    sleep 60

````
### Explica√ß√£o do C√≥digo:

>`#!/bin/bash` - Indica que o script ser√° executado usando o interpretador de comandos do Bash. √â obrigat√≥rio em scripts Bash. Chama-se "shebang".

>`SITE_URL="http://devseclaranja.local"` - Vari√°vel chamada SITE_URL que armazena o endere√ßo do site que vamos monitorar. No meu caso eu personalizei, mas pode ser chamado localhost ou at√© o ip da m√°quina.

>`WEBHOOK="https://discord.com/api/webhooks/..."` - Outra vari√°vel, chamada WEBHOOK, guarda o link do webhook do Discord. Esse link √© onde as mensagens v√£o ser enviadas quando o site estiver offline. No caso desse est√° incompleto por motivos de seguran√ßa.

>`LOG="/var/log/devseclaranja.log"` - Essa vari√°vel define o caminho do arquivo de log onde os status do site (online ou offline) ser√£o salvos.

>`while true; do` - Esse comando inicia um loop infinito, ou seja, o script vai rodar para sempre, verificando o site continuamente.

>`DATA_HORA=$(date '+%d/%m/%Y %H:%M:%S')` - Essa linha salva a data e a hora atual numa vari√°vel chamada DATA_HORA. O comando date formata a data nesse padr√£o: dia/m√™s/ano hora:minuto:segundo.

>`STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL")` - Aqui usamos o curl para checar se o site est√° online:
-s: modo silencioso (n√£o mostra nada no terminal).
-o /dev/null: ignora o conte√∫do da resposta.
-w "%{http_code}": mostra somente o c√≥digo HTTP (como 200, 404, 500, etc).
Tudo isso √© armazenado na vari√°vel STATUS.
Se o site estiver ok, STATUS ser√° 200.

>`if [ "$STATUS" != "200" ]; then` - Se o c√≥digo de status n√£o for 200, isso significa que o site est√° com problema.

>`echo "$DATA_HORA - [$SITE_URL] est√° offline! Status: $STATUS" >> "$LOG"` - Essa linha grava uma mensagem no log, dizendo que o site est√° offline. O >> serve para adicionar a mensagem ao final do arquivo, sem apagar o conte√∫do anterior.

>`curl -H "Content-Type: application/json" \
-X POST \
-d "{\"content\": \"O site [$SITE_URL] est√° apresentando erro! C√≥digo HTTP: $STATUS - $DATA_HORA\"}" \
"$WEBHOOK"` - Aqui, usamos novamente o curl, mas dessa vez para enviar uma mensagem para o Discord: -H: define o tipo de conte√∫do (JSON). -X POST: envia os dados como um POST (envio de formul√°rio). -d: os dados a serem enviados. No caso, um texto formatado com a vari√°vel de status e a hora. "$DISCORD_WEBHOOK": √© o destino da mensagem.

>`else
echo "$DATA_HORA - [$SITE_URL] Est√° online! - Status: $STATUS" >> "$LOG_FILE"` - Se o status for 200, o site est√° online, e isso √© salvo no arquivo de log tamb√©m.

>`fi` - Fecha o bloco do if.

>`sleep 60` - Faz o script esperar 60 segundos antes de repetir tudo de novo. Assim, ele faz a checagem uma vez por minuto.

>`done` - Fecha o while, e o loop come√ßa de novo.

---

## Etapa 4 - Teste e valida√ß√£o da solu√ß√£o:
    Ap√≥s modificar o index.html e criar o script, chegou a hora de testar. abro a m√°quina virtual, abro o terminal, entro no modo root atrav√©s do:
    >`sudo su`

    E para testar o webhoook, iremos parar o nginx:
    >`systemctl stop nginx`

    Agora vamos testar com o comando:
    >`bash verifica_siteprojeto.sh`

    E as mensagens come√ßaram a chegar.
    ![print 7](/Prints/7.png)

    Caso queira voltar e s√≥ utilizar o comando:
    >`systemctl restart nginx`

    Ap√≥s ver que as mensagens est√£o chegando, vamos conferir o log:
    ![print 8](/Prints/8.png)

    Assim temos as informa√ß√µes, data e hor√°rio.

---
## Etapa Final - Conclus√£o
    Ap√≥s testar, alcan√ßamos as metas do projeto e verificamos seu funcionamento. Vou deixar algumas refer√™ncias utilizadas para concluir esse projeto.

    * Primeiros Passos no Linux - Conceitos e Principais Comandos - Udemy

    * Descubra como configurar o NGINX: AULA COMPLETA com dicas de seguran√ßa e performance - Youtube

    * Programa√ß√£o Shell Script - Automatizando Rotinas no Linux - Udemy


